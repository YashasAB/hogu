
modules = ["nodejs-20"]

# IDE Run button (local dev)
run = "bash -lc \"pnpm dev\""

[nix]
channel = "stable-25_05"
packages = ["psmisc", "lsof"]

[deployment]
build = [
  "bash",
  "-lc",
  "set -e; (corepack enable || true); (corepack prepare pnpm@8.15.6 --activate || npm i -g pnpm@8.15.6); pnpm -v; rm -rf apps/api/dist; cd apps/api; pnpm install --no-frozen-lockfile; pnpm prisma generate; pnpm build; mkdir -p data; export DATABASE_URL=${DATABASE_URL:-file:./data/prod.db}; pnpm prisma migrate deploy || pnpm prisma db push",
]
run = [
  "bash",
  "-lc",
  "cd apps/api && exec env NODE_ENV=production node dist/index.js",
]


[objectStorage]
defaultBucketID = "replit-objstore-5d4a1c81-2e13-484c-92e0-96c3c7f4803f"

[[ports]]
localPort = 5000
externalPort = 5000

[[ports]]
localPort = 5001
externalPort = 3001

[[ports]]
localPort = 5555
externalPort = 3000

[[ports]]
localPort = 8080
externalPort = 80
